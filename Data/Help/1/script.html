<html>
<head>
  <title>Help for Deadly Rooms of Death</title>
</head>
<body bgcolor="#FFFFFF">
<img src="images/drodlogo.jpg" />
<hr />
<h3><u>Character Script Commands</u></h3>
<p>When the player enters the room, NPCs start performing the behavior you
designate.  There are four general classes of script commands, as follows:</p>
<ol>
  <li><a href="#placement">Placement</a></li>
  <li><a href="#condition">Condition</a></li>
  <li><a href="#interaction">Interaction</a></li>
  <li><a href="#queries">Queries</a></li>
  <li><a href="#decision">Decision making</a></li>
</ol>
<p>
<a href="#usagenotes">Notes about using NPC scripts</a><br />
<a href="#imperativelist">Imperatives</a><br />
<a href="#branchingexamples">Examples of branching code structures</a><br />
<a href="#commandkeyexample">Example of using the Special Command key</a><br />
<a href="#world-map-command-ex">Example of using World Map commands</a><br />
<a href="#predefined-script-vars">Predefined script vars</a><br />
<a href="#threatclockdisplay">Threat clock display modes</a><br />
<a href="#playerinputvars">List of player command input variables</a><br />
<a href="#image-overlay-commands">Image Overlay commands</a>
</p>
<hr />

<p><a name="placement"><b>1.&nbsp;&nbsp;Placement</b></a> - Change the NPC's location.</p>
<ol>
  <li><a name="appear"><b>Appear</b></a> - If not visible, the NPC will appear
      at the current square (i.e. it enters the room).  This command does
      nothing if the NPC is already visible. If a monster or the player occupies
      the square it is appearing in, then the NPC will wait until the square is
      vacant to appear.</li>
  <li><a name="appearat"><b>Appear at</b></a> - Use this to have an invisible
      NPC enter the room at a designated square different from the one where the
      NPC is current located. After selecting this command, the room will
      temporarily appear.  Click on a square to select where the NPC will enter
      the room. This command does nothing if the NPC is already visible.  If a
      monster or the player occupies the square the NPC is to appear in, it will
      wait until the square becomes vacant to appear.</li>
  <li><a name="disappear"><b>Disappear</b></a> - Removes the NPC from the room,
      making him invisible. Use this to show an NPC leaving the room. Script
      commands continue to play while the character is invisible but the NPC
      will not physically interact with any room elements unless it Appears
      again.</li>
  <li><a name="moveto"><b>Move to</b></a> - The NPC will move to the indicated
      square (selected by clicking on a room square, as above).  Optionally, one
      of the entity types listed in the adjacent list box may be selected as who
      the NPC should follow. Hold &lt;Ctrl&gt; while clicking to select and
      unselect multiple selections. Each turn, the NPC will attempt to move one
      square closer to its destination. It moves roughly in a straight line and
      won't move on a given turn if something is in its way.
      <a name="forbidturning">Enable</a> "Forbid turning" if you don't want the
      monster turning to face the direction it is moving each step. Hint: If you
      want the NPC to move in a more complex fashion, such as following a
      twisting corridor, this can be accomplished with a sequence of <b>Move
      to</b> commands, one to navigate each twist in the corridor.  This command
      finishes when the NPC arrives at the destination square.
      <a name="singlestep">Enable</a> "Single step" to have the NPC only attempt
      to make a single step toward the indicated destination before continuing
      to the next script command.  If no move can be made, the next script
      command is executed on the next turn.</li>
  <li><a name="move"><b>Move</b></a> - Similar to <a href="#moveto"><b>Move
      to</b></a>, except a relative number of tiles to move from the NPC's
      current location is specified.  Positive numbers indicate movement south
      and east, and negative numbers are for moving north and west.</li>
  <li><a name="facedirection"><b>Face direction</b></a> - Initially, the NPC
      faces the direction it is oriented when placed in the room.  Use this
      command to turn the NPC in a different direction without moving (takes 1
      turn).</li>
  <li><a name="face-towards-like-guard"><b>Face towards like guard</b></a> - Use this command to make the NPC change the direction they're facing towards a given point or entity just as the guard would.<br/>
      <a name="face-towards-like-guard-single-step"><u>Single step</u></a>: Setting this to <i>on</i> will make the character slowly turn towards the target direction. <i>Off</i> will make it turn immediately, just as <i>face direction</i> does.<br />
      <a name="face-towards-like-guard-targets"><u>Targets</u></a>: You can select zero, one or multiple targets from the list of entity groups - ctrl+click to deselect/select multiple. If no group is selected you will be asked to select a tile towards which the NPC should face.<br />
      <a name="face-towards-like-guard-conditions"><u>Using in conditions</u></a>: This command can be used with <a href="#if">if statements</a> to check if the character is already facing the target direction.<br />
      <a name="face-towards-like-guard-my-script"><u>Using MyScript</u></a>: This command supports the following MyScript parameter injections: <b>X/Y</b> - position in the room if no target group is selected; <b>W</b> - single step 0/1; <b>F</b> - bit map of the target groups.</li>
  <li><a name="teleport-to"><b>Teleport to</b></a> - Instantly moves the NPC
      to the indicated tile, as long as another entity is not occupying it.</li>
  <li><a name="teleport-player-to"><b>Teleport player to</b></a> - Instantly moves the player to the indicated tile processing all interactions: player will drown or fall into pit, potions will be drunk,
      the weapon will stab, pressure plates will toggle, etc. <br/>
      <a name="teleport-player-to-potions"><u>Interactions with potions</u></a>: If the player is teleported multiple time during a single turn and they happen to land on one or more blocking potions (mimic, decoy and clone) then only the first of these potions will be consumed. However if the blocking potion is followed by non-blocking ones (invisiblity, speed, horns) they will be drunk. Horns are considered potions by the game. Avoid using this obscure mechanic in puzzles.<br />
      <a name="teleport-player-to-blocked-teleport"><u>Blocked teleports</u></a>: This command will be silently ignored if you try to teleport the player: onto another monster/entity which can't be killed by stepping, to a location outside the room boundaries, onto the tile currently occupied by the player.<br />
      <a name="teleport-player-to-temporal-split"><u>Temporal recording</u></a>: If the player gets teleported the quantum flux will reset and stop the temporal recording.<br />
      <a name="teleport-player-to-consequences"><u>Monsters on target tile</u></a>: You can teleport onto a monster and instantly kill it if you are currently capable of killing that monster by stepping onto it. You can't teleport onto monsters that leave a pile behind, just like you can't step on them in the Slayer role or while wielding a dagger (in case of the dagger it's the stab that kills, you don't actually end up moving onto their space).<br />
      <a name="teleport-player-to-my-script"><u>Using MyScript</u></a>: This command supports the following MyScript parameter injections: <b>X/Y</b> - position where the player should be teleported.<br />
      </li>
</ol>

  <p>
    <a name="condition"><b>2.&nbsp;&nbsp;Condition</b></a> - How the NPC
    functions.</p>
  <ol>
    <li><a name="setappearance"><b>Set appearance</b>
      </a> - Changes the NPC's "Graphic" and default properties to the specified entity type.</li>
    <li><a name="turnintomonster"><b>Turn into monster</b>
      </a> - Turns the NPC into a regular monster of the type indicated by its graphic.
      This ends script execution immediately and the NPC is permanently replaced by a regular monster.</li>
    <li><a name="imperative"><b>Imperative</b></a> - Sets a special status
      condition on the NPC (see <a href="#imperativelist">Imperatives</a>).
      Compatible imperatives may be combined.</li>
  </ol>

<p><a name="interaction"><b>3.&nbsp;&nbsp;Interaction</b></a> - How the NPC
interacts with its environment.</p>
<ol>
  <li><a name="activateat"><b>Activate item at</b></a> - Activates the item at
      the room square you select. Items that can be activated are: orbs,
      pressure plates, lights and wall lights. Nothing will happen this turn if
      no relevant item is at the indicated square. Hint: Move the character next
      to orbs before striking them for more intuitive behavior.  If no one is
      next to the orb when struck, it will appear that Beethro is using his
      portable orb.</li>
  <li><a name="speech"><b>Speech</b></a> - Causes someone in the room to say
      something.<br />
      <a name="dialogtext"><u>Dialog text</u></a>: Type the words that are said.
      This may be left blank in order to only play a sound effect.<br />
      <a name="speaker"><u>Speaker</u></a>: who says the words. The text appears
      next to the person's figure in the room and their face appears on screen
      while they are speaking.  Use "Custom" to have the NPC "throw its voice"
      to a different square in the room.  If a monster or character is located
      at the indicated square when this command is executed, it will appear as
      if this monster or character is speaking. If speaker is set to "None", or
      the person indicated is not present in the room, then the words will
      appear next to the NPC.<br />
      <a name="mood"><u>Mood</u></a>: the face displays the indicated mood.  Not
      all moods are available for all speaker types.<br />
      <a name="speechdelay"><u>Speech delay</u></a>: How long, in milliseconds,
      the speech lasts for.  If placing multiple lines of speech in sequence,
      this determines how much time passes until the next line of speech (and
      corresponding speaker) is displayed.  Set this value to zero to have the
      game engine calculate how long to wait based on the length of the speech
      text.<br />
      <a name="addsound"><u>Add sound</u></a>: A sound file (Wave or Ogg Vorbis
      format) on disk can be optionally attached to the speech.  If a sound is
      specified, it will play along with the text and the next speech command
      will be played when the sound completes. Use a non-zero speech delay to
      force when the next line of speech will play regardless of how long the
      attached sound file plays.<br />
      <a name="exportspeech"><u>Exporting speech text</u></a>: A hold's entire
      speech script can be exported to an HTML file on disk when exporting the
      hold by adding the line "ExportSpeech=1" to the "[Startup]" section of
      Data/drod.ini.
  </li>
  <li><a name="flushspeech"><b>Flush Speech (on/off)</b></a> - Tells the game to
      immediately process any previously queued speech that hasn't had time to
      play yet.  If "On" is selected, these texts will appear immediately
      onscreen.  If "Off" is selected, then text that hasn't played yet won't
      show at all. Hint: This command is used for dramatic effect, to ensure
      speech queued after this command will be immediately spoken, as intended.
      This command is not needed if it doesn't matter at what point in play
      speech texts are delivered.</li>
  <li><a name="ambient"><b>Ambient sound</b></a> - Plays a custom sound effect,
      imported from a sound file on disk.  Select "Loop Off" to play the sound
      once, and "Loop On" to play the sound repeatedly.  Selecting no sound file
      in conjunction with this command will silence any ambient sounds playing
      when the command is executed.</li>
  <li><a name="ambientat"><b>Ambient sound at</b></a> - Plays a custom sound
      effect, imported from a sound file on disk, from the room location you
      specify.  The sound will play from the direction the sound is coming to
      the player in the room and will be quieter the further the player is away
      from that room tile.  Selecting no sound file in conjunction with this
      command will silence any ambient sounds currently playing at the room
      location you specify.</li>
  <li><a name="buildmarker"><b>Build marker</b></a> - Mark a region of the room
      for building a certain object by citizen builders.  When a builder builds
      on a tile, the tile is unmarked. Each room tile can be marked only by a
      single object type at a time. Selecting "None" unmarks any existing build
      markers in the room region you specify.</li>
  <li><a name="build"><b>Build</b></a> - Instantly build the indicated object in
      the specified room region. You may also remove objects from the specified
      room layer.</li>
  <li><a name="destroy-trapdoor"><b>Destroy trapdoor</b></a> - Causes a trapdoor
      at the indicated location to drop down.</li>
  <li><a name="gotoentrance"><b>Go to level entrance</b></a> - Sends the player
      immediately to any level entrance defined in the hold, or ends the hold.</li>
  <li><a name="attacktile"><b>Attack tile</b></a> - Executes an attack of the designed damage type to the designated tile.</li>
  <li><a name="playvideo"><b>Play video</b></a> - Plays a video file, imported
      from a video file on disk, at the specified screen coordinates.  Sound
      tracks in video files are not supported, but sounds and music may be
      played concurrently with the proper script commands.
      <a name="supportedvideo">Currently</a>, only Ogg Theora video format is
      supported.</li>
  <li><a name="setmusic"><b>Set music</b></a> - Set any of the available music
      themes to play. Additionally, custom music, imported from a music file on
      disk, may be played. Only Ogg Vorbis and Wave formats are supported.
      Custom music can be set to continue playing across rooms by executing this
      command on room entrance.</li>
  <li><a name="role"><b>Player role</b></a> - Indefinitely sets the player to
      play the role you indicate. In these roles, properties that apply to that
      entity type generally hold.</li>
  <li><a name="setplayerstealth"><b>Set player stealth</b></a> - Change the player's stealth property on room entrance to the indicated value indefinitely.</li>
  <li><a name="setplayerweapon"><b>Set player weapon</b></a> - Change the player's current weapon type, or enable or disable wielding a weapon indefinitely.</li>
  <li><a name="cutscene"><b>Cut scene</b></a> - When set, room turns will
      proceed automatically at the rate you specify without player intervention.
      Invoke this command with a rate of "0" to end the cut scene and return
      movement control to the player. Hint: This command is used for dramatic
      effect, to have NPCs do things, such as move around the room, without
      requiring the player to take turns to allow the NPCs to likewise move.
      If on a given turn no NPCs are executing, the cut scene playing will
      automatically terminate, restoring control to the player.</li>
  <li><a name="answer"><b>Answer option</b></a> - Provides a multiple choice
      option for a <a href="#question"><b>Question</b></a> command (see below).
      A label from the list of defined <a href="#label"><b>Label</b></a>
      commands in the script must be selected as the point from where the script
      will continue execution if the user selects this choice.
      Up to nine answer options are supported for a given Question.  Any
      additional options are ignored.</li>
  <li><a name="setvar"><b>Set var</b></a> - Each hold you create contains a set
      of zero or more variables, named by you.  Use these variables to track
      persistent game state information across rooms during play. To add a variable
      to a hold, type its name into the uppermost text box and click "Add".<br />
	 <u>Syntax</u>: Variable names must begin with a letter or period and not contain any punctuation
	  except underscore ('_').  <a href="localvars">Starting</a> a variable name with a period ('.') configures it as a local variable instead of a global. This means each NPC will have its own version of a variable with this name and there is no value sharing among them.<br />
      <u>Modifying variables</u>: <a name="varops">Select</a> a hold variable from the list, choose an
      operation and a value. Variables may either store an integer or text. If
      the operation you specify is "Assign text" or "Add text", the variable you
      select will be set to store the text you provide. You may also reference
	  other variables to insert into the given text.  For operations dealing
      with numbers, if you provide the name of another variable, its value will
      be used (invalid names will be considered a value of 0). Otherwise, the
      number you provide is used. Use the text box on top to specify the text
      being assigned or added to the variable. For other operations, use the
      text box on the right to input a number or variable name. The variable
      will store a number.<br />
      <a name="varsintext"><u>Using variables in text</u></a>:
    In variable text assignments,
    <a href="#speech">Speech</a>, <a href="#question">Questions</a>
      (see below), level entrance texts, and scroll text,
      type "$&lt;var name&gt;$" to insert the
      current value of the variable you name at this point in the text.
	  Type "$\n$" to skip to the next line of text.<br />
      <a name="varref"><u>Comprehensive variable reference list</u></a>:
      In the <a href="editroom.html">Room Editor Screen</a>, press F2 to output
      a comprehensive list of hold variables to the clipboard (use the paste
      option of your favorite text editor to view this text). This list shows
      all rooms and NPC (x,y) locations where the variable is referenced in a
      script throughout the hold. A number after the (x,y) location of the
      script indicates how many times the variable is referenced in that script.<br />
      <a name="varmonitor"><u>Monitoring variables during play</u></a>:
      Press Ctrl-F7 while playing to turn on and off the variable monitor.
      Whenever a script changes a hold variable, you will be notified onscreen.
      This only works while playtesting, playing a hold you authored, or playing
      a CaravelNet hold in beta.<br />
      <u>Deleting variables</u>: To permanently remove a hold variable, select it from the list box on the
      left and click "Remove".  Note that this removes the variable completely
      from the hold and all NPC scripts that use it, not just from this
      particular script.<br />
</li>
  <li><a name="setshallowwatertraversal"><b>Set shallow water traversal</b>
    </a> - Sets how and under what conditions the player interacts with shallow water terrain.</li>
  <li><a name="gameeffect"><b>Game effect</b>
  </a> - Display a visual effect at a specified room location.  Particle effects may have a direction
    given them.  Some effects may play an optional accompanying sound effect.</li>
  <li><a name="image-overlay"><b>Image overlay</b></a> - Input a <a href="#image-overlay-commands">custom set of commands</a> for displaying a custom image effect in the game room.</li>
  <li><a name="generateentity"><b>Generate entity</b>
    </a> - Creates a new
    entity of the specified type at room location (x,y) and the indicated
    orientation once that room tile is vacant.  Custom NPCs with a default
    script defined may be created where an entity already occupies the room tile,
    but begins as not visible.
    NPCs will begin executing their default script when created.</li>
  <li><a name="startglobalscript"><b>Start global script</b>
    </a> - Begin executing the specified NPC's default script.
    To use this command, first create a custom NPC role, then give it a default script.
    The global script will automatically run in each room you enter for the rest of the campaign, until an <a href="#end">End</a> command or variant is executed.
    Only one instance of each custom NPC may be run as a global script while in any given room.</li>
  <li><a name="displayfilter"><b>Display filter</b>
  </a> - Display the room with the indicated graphic filter.</li>
  <li><a name="flashingmessage"><b>Flashing message</b>
  </a> - Flash a message onto the room area.  By default, the text is displayed in bright yellow. You may specify an alternate color by providing a six-character RGB hexadecimal code, with each two-character pair indicating a color value between 0 and 255.</li>
  <li><a name="challenge"><b>Challenge</b></a> - Used for the CaravelNet achievement/trophy system. When executed, this indicates that a challenge with the given name has been completed by the player.</li>
  <li><a name="world-map-select"><b>World Map Select</b></a> - Select an overworld map for subsequent World Map commands to be performed with reference to. Without this command, the other World Map commands will do nothing.</li>
  <li><a name="world-map-music"><b>World Map Music</b></a> -
Sets the music that plays on the previously selected map. This only need be executed once during a hold playthrough. Any subsequent executions will override the previous setting.</li>
  <li><a name="world-map-tile-icon"><b>World Map Tile Icon</b></a> - Places an icon on the previously selected map. You specify the position the icon appears on the map, its state, and if active, what level entrance or map it leads to when the player clicks on it from this map screen. Icons persist on the specified map from that moment for the entire playthrough. Placing an icon at the same position as another will override the first. Using icon type "Off" will remove an icon from the map. You can select a custom NPC with a looping animation speed in order to display an animated graphic on the map.</li>
  <li><a name="world-map-image-icon"><b>World Map Image Icon</b></a> - Places an image on the previously selected map. Works in other respects as the "World Map Tile Icon" command.</li>
</ol>

<p><a name="queries"><b>4.&nbsp;&nbsp;Queries</b></a> - Use queries to examine
the state of the room and wait indefinitely until certain events occur.</p>
<ol>
  <li><a name="question"><b>Question</b></a> - If one or more <a href="#answer">
      <b>Answer option</b></a> commands have been provided previously in script
      execution, this will ask the user a multiple choice question with the
      dialogue you specify and answer options previously provided. Script
      execution will continue from the label of the Answer option selected by
      the player.  Once a <b>Question</b> has been asked, the list of Answer
      options is reset for the next <b>Question</b>.<br />
      If no <a href="#answer"><b>Answer option</b></a> commands have been
      provided before this command is executed, the user will be asked a "Yes"
      or "No" question with the dialogue you specify. If a yes/no
      <b>Question</b> is executed as the condition for an <a href="#if">
      <b>If ...</b></a> command, the corresponding script block will execute if
      the user answers "Yes".</li>
  <li><a name="istileopen"><b>Is tile open</b></a> - Check whether the indicated tile is open for the NPC to move to from its current location.</li>
  <li><a name="wait"><b>Wait</b></a> - This tells the NPC to do nothing until
      the number of game turns you specify has passed.  <b>Wait 0</b> will stop
      the script at the current point until the next turn.</li>
  <li><a name="waitevent"><b>Wait for event</b></a> - The NPC waits until the
      specified game event has taken place.</li>
  <li><a name="waitentity"><b>Wait for entity</b></a> - The NPC waits for any of
      the selected entity type (or entities) to enter the room region you
      specify.  Hold &lt;Ctrl&gt; while clicking to select and unselect multiple
      selections.  After selecting this command, the room will temporarily
      appear.  Hold down the mouse button and drag the mouse cursor to select
      the area any of the entity or entities must enter before the NPC does
      anything else.</li>
  <li><a name="waitentityis"><b>Wait while entity</b></a> - Wait while any of
      the selected entity type remains in the room region that you select.</li>
  <li><a name="waitdoor"><b>Wait for door to (open/close)</b></a> - Waits for
      the door at the selected room square to either open or close.</li>
  <li><a name="waitturn"><b>Wait for turn</b></a> - The NPC does nothing until
      at least the specified number of game turns has passed since the player
      entered the room.</li>
  <li><a name="waitclean"><b>Wait for clean room</b></a> - Waits until the room
      is in a conquer-ready state (i.e. all kill-required monsters have been
      removed).</li>
  <li><a name="waitcleanlevel"><b>Wait for clean level</b></a> - Waits until the level
      has been cleared (i.e. all required rooms have been
      cleared).</li>
  <li><a name="wait-for-entity-type"><b>Wait for Entity Type</b></a> - Wait for a specific entity type to be present in a specified room region.</li>
  <li><a name="wait-while-entity-type"><b>Wait while Entity Type</b></a> - Wait while a specific entity type is present in a specified room region.</li>
  <li><a name="waitplayerface"><b>Wait for player to face</b></a> - Waits until
      the player turns in the specified direction.</li>
  <li><a name="waitplayerinput"><b>Wait for player to input</b></a> - Waits until the player inputs the specified command.</li>
  <li><a name="waitplayermove"><b>Wait for player to move</b></a> - Waits until
      the player moves in the specified direction.</li>
  <li><a name="waitplayertouch"><b>Wait for player to touch me</b></a> - Waits
      until the player bumps into the NPC.</li>
  <li><a name="waitnobuildmarkers"><b>Wait for no building markers</b></a> -
      Waits until no script-defined <a href="#buildmarker">building markers</a>
      exist in the room region you specify.</li>
  <li><a name="waitvar"><b>Wait until var</b></a> - Waits until a <a href="#setvar">
      hold variable</a> meets the condition you specify.</li>
  <li><a name="waitforitem"><b>Wait for item</b>
    </a> - Wait until the specified element is located in the marked room region.</li>
	 <li><a name="get-natural-target"><b>Get natural target</b></a> - Finds the position of the entity this character would target if it was a monster and stores it in two global variables, <b>_ReturnX</b> and <b>_ReturnY</b>.<br/>
      <a name="get-natural-target-targeting-type"><u>Targeting type</u></a>: You can chose what type of targeting to use when finding the target. Currently supported is <i>Regular monster</i> which is the targeting used by unbrained roaches, goblins, etc.<br />
      <a name="get-natural-target-results"><u>Results</u></a>: Results from this function are stored in <b>_ReturnX</b> and <b>_ReturnY</b> which are global variables, accessible by all scripts.<br />
	  <a name="get-natural-target-no-target"><u>No target</u></a>: If no target is found the character's current position will be returned.<br />
      <a name="get-natural-target-using-in-conditions"><u>Using in conditions</u></a>: This command <b>cannot</b> be used with an <a href="#if">if statements</a>.<br />
	  <a name="get-natural-target-using-my-script"><u>Using MyScript</u></a>: This command supports the following MyScript parameter injections: <b>X</b> - type of targetting (0=Regular monster).</li>
	<li><a name="get-entity-direction"><b>Get entity direction</b></a> - Gets the direction an entity at a given position is facing and stores the result in <b>_ReturnX</b>.<br/>
      <a name="get-entity-direction-direction-values"><u>Direction values</u></a>: NW=0, N=1, NE=2, W=3, No orientation=4, E=5, SW=6, S=7, SE=8.<br />
      <a name="get-entity-direction-guard-targets"><u>Results</u></a>: Result from this function is stored in <b>_ReturnX</b> which is a global variables, accessible by all scripts.<br />
	  <a name="get-entity-direction-no-target"><u>No target</u></a>:  If no entity is found the function returns No orientation. If player is found on the specified position, the player's direction is returned.<br />
      <a name="get-entity-direction-using-in-conditions"><u>Using in conditions</u></a>: This command <b>cannot</b> be used with an <a href="#if">if statements</a>.<br />
	  <a name="get-entity-direction-using-my-script"><u>Using MyScript</u></a>: This command supports the following MyScript parameter injections: <b>X/Y</b> - position to check.</li>
</ol>

<p><a name="decision"><b>5.&nbsp;&nbsp;Decision making</b></a> - Use the
following commands to execute only a marked portion of script commands or to
continue executing script commands from a different location in the script.</p>
<ol>
  <li><a name="if"><b>If ...</b></a> - Use this command to optionally run a
      block of one or more script commands, based on a condition you specify in
      the next script command, which must be a query. If the query is
      immediately satisfied, then the script commands that follow after will be
      executed.  An <a href="#ifend"><b>If End</b></a>,
      <a href="#else"><b>Else</b></a> or <a href="#else-if"><b>Else if</b></a> command indicates the end of the optional
      code block. If the following query is not true, the script will continue
      after the following the next <a href="#else"><b>Else</b></a> or
      <a href="#ifend"><b>If End</b></a> command that marks the end of the
      optional code block.</li>
  <li><a name="if"><b>If ...</b></a>. The end of the <a href="#else"><b>Else</b></a>
      block is indicated with an <a href="#ifend"><b>If End</b></a> command.</li>
  <li><a name="else"><b>Else</b></a> - Marks the beginning of a script section
      that is executed if the query condition following the
      <a href="#if"><b>If ...</b></a> command is <u>not</u> satisfied.
      <b>Else</b> commands in conditional blocks are optional, but they must
      always follow somewhere after an <a href="#if"><b>If ...</b></a> to be
      meaningful.</li>
  <li><a name="else-if"><b>Else if</b></a> can optionally be used instead of <a href="#else"><b>Else</b></a> to avoid nesting script commands. It works exactly the same as nesting an <a href="#if"><b>If ...</b></a> <a href="#ifend"><b>If End</b></a> block inside an <a href="#else"><b>Else</b></a></li>
  <li><a name="ifend"><b>If End</b></a> - Marks the end of
      <a href="#if"><b>If ...</b></a> and <a href="#else"><b>Else</b></a> blocks.<br />
      <a name="condnotes">Notes:</a>
      <ol>
        <li>A "?" symbol displayed in front of a command in the script list
            means the command is not a recognized as a valid condition for an
            <a href="#if"><b>If ...</b></a> command.</li>
        <li><a href="#if"><b>If ...</b></a> commands may be nested, i.e., an
            inner code block may be completely contained within an outer code
            block.</li>
        <li>A "!" symbol displayed in front of a command in the script list
            means that an <a href="#if"><b>If ...</b></a> or
            <a href="#else"><b>Else</b></a> block is not properly closed with an
            <a href="#ifend"><b>If End</b></a> command at the end, or that an
            <a href="#else"><b>Else</b></a> command is placed without an
            <a href="#if"><b>If ...</b></a> coming first.</li>
        <li>See "<a href="#branchingexamples">Examples of branching code
             structures</a>" below.</li>
      </ol></li>
  <li><a name="label"><b>Label</b></a> - marks a location in the script to
      continue executing commands from (used in conjunction with
      <a href="#goto"><b>Go to</b></a> and <a href="#answer"><b>Answer option</b></a>
      commands).  Also, labels may be used to simply comment in normal language
      on what the following script commands do.</li>
  <li><a name="goto"><b>Go to</b></a> - Select a label to continue executing
      commands from.  Hint: Use "Go to" to make a loop in the script that repeats a
      sequence of commands over and over. Use a <a href="#wait"><b>Wait 0</b></a>
      command as the last statement of a loop that is to be executed once each
      turn.</li>
  <li><a name="gosub"><b>Gosub</b></a> - Similar to "Go to", it continues execution from the indicated label. Used in conjunction with "Return" for more modular scripting.</li>
  <li><a name="return"><b>Return</b></a> - Continue executing commands from the most recent "Gosub" command executed. When multiple Gosub commands are executed, then multiple Return commands will jump back to these in order from most to least recent.</li>
  <li><a name="endonexit"><b>End on room exit</b></a> - Removes the NPC for the
      rest of the current game once the player exits the room.  If the room is
      restarted before exit, then the NPC script will begin executing again from
      the beginning. Hint: use this command to have the NPC continue executing
      commands.</li>
  <li><a name="end"><b>End</b></a> - Ends the character script immediately and
      will remove the NPC for the rest of the current game once the player exits
      the room. If the room is restarted before exit, then the NPC script will
      begin executing again from the beginning. Hint: use this command to stop
      the NPC from executing any more commands.</li>
</ol>

<p><a name="usagenotes"><b>Notes about using NPC scripts</b></a></p>
<ol>
  <li><a name="lifecycle">Each</a> character script begins execution when the
      room is entered. Once a script runs to completion, the character stops
      functioning.  If the NPC is still in the room when the script ends, it
      will remain where it is until the player exits the room.  Upon reentry,
      the script will start again from the beginning.</li>
  <li>NPCs are not used to determine room completion (conquer status). That is,
      NPCs with un-<a href="#end"><b>End</b></a>ed scripts will continue to
      appear in a conquered room each time the player reenters it.</li>
  <li><a name="dontrestart">A</a> script can be made to not start again when
      the player reenters the room by placing an <a href="#end"><b>End</b></a>
      command at the end of the script or by executing an
      <a href="#endonexit"><b>End on room exit</b></a> command anywhere within
      the script.  A character can be made to run only while the room is
      unconquered by placing an <b><a href="#if">If</a>
      &lt;<a href="#waitclean">Wait for Clean Room</a>&gt;</b> check at the
      beginning of the script and <a href="#ifend"><b>If End</b></a> at the end.</li>
  <li>An NPC can be turned into a regular monster with the
      <a href="#turnintomonster"><b>Turn into monster</b></a> command.  In this
      case, it may need to be killed in order to conquer the room.</li>
</ol>

<p><a name="imperativelist"><b>Imperatives</b>
</a> - NPC/script properties that may be set with the <a href="#imperative">Imperative</a> command.</p>
  <ol>
    <li><a name="impvulnerable"><u>Vulnerable</u></a>: Makes the NPC vulnerable to
      killing. This is the default setting for most NPC graphic types.</li>
    <li><a name="impinvulnerable"><u>Invulnerable</u></a>: Makes the NPC
      invincible so it cannot be killed by stabbing or other methods of
      inflicting damage. The NPC may still be killed by falling off a platform
      or by briar growth.  Some NPC types, like Wubbas, are invulnerable by
      default.</li>
    <li><a name="impcritical"><u>Critical hero</u></a>: When set, the room will
      restart if the NPC is ever killed. Some NPC types, like Beethro and Halph,
      are marked critical heros by default.</li>
    <li><a name="imprequired"><u>Required target</u></a>: When set, the NPC must
      be killed in order to conquer the room.  This command only applies when
      the room is not otherwise clean on entrance.</li>
    <li><a name="impsafe"><u>Safe</u></a>: Forbids the NPC to step on the player
      and kill him (default).</li>
    <li><a name="impswordsafe"><u>Sword safe to player</u></a>: Sword stabs from
      this NPC won't harm the player.</li>
    <li><a name="impdeadly"><u>Deadly</u></a>: Allows the NPC to step on the
      player and kill him.  Also makes sword hits deadly to the player (default).</li>
    <li><a name="impdie"><u>Die</u></a>: Makes the NPC die with a blood splatter.</li>
    <li><a name="impdiespecial"><u>Die special</u></a>: Makes the NPC perform a
      monster-specific death sequence, if applicable.  Currently, this command
      applies to rock golems and fegundos. Rock golem NPCs will turn into a rock
      pile when this command is invoked. Fegundos will explode and turn into a
      regular fegundo ash monster. For other monster types, this acts
      identically to "Die".</li>
    <li><a name="impendwhenkilled"><u>End when killed</u></a>: If the NPC is killed,
      mark the script as ended so it doesn't repeat when the room is reentered.</li>
    <li><a name="impdirectonlybeelining"><u>Direct-only beelining</u></a>: When
      desired diagonal movement is blocked, then don't move at all.</li>
    <li><a name="imp-normal-beelining"><u>Normal beelining</u></a>: Move diagonally when desired and possible, otherwise move axially if possible, prefering vertical movement when both horizontal and vertical movements are open.</li>
    <li><a name="imp-smart-beelining"><u>Smart beelining</u></a>: In addition to Normal beelining behavior, when a
      desired diagonal movement is blocked, choose the better of
      horizontal or vertical movement that will get closer to the destination (default).</li>
    <li><a name="impflexiblebeelining"><u>Flexible beelining</u></a>: As Smart beelining, but also will move diagonally closer to the destination when a desired axial move is blocked.</li>
    <li><a name="imp-pathfinding-openonly"><u>Pathfinding (open only)</u></a>: The shortest path is calculated and taken to the destination.  Whenever the currently calculated path becomes blocked, then a new shortest path is calculated. When no open path is found, no movement is made.</li>
    <li><a name="imp-pathfinding"><u>Pathfinding</u></a>: The most intelligent movement option. The shortest path is calculated and taken to the destination. Whenever the currently calculated path becomes blocked, or a shorter path becomes available to a mobile target, then a new shortest path is calculated. When no open path is found to the destination, then the path that has the fewest obstacles along the way is followed, defaulting to normal beelining whenever obstacles completely block the remaining path.</li>
    <li><a name="imp-brain-pathmap-obstacle"><u>Brain pathmap obstacle</u></a>: This NPC is perceived as an obstacle to brain pathmaps, and brained pathmaps will calculate paths around the NPC.</li>
    <li><a name="imp-not-brain-pathmap-obstacle"><u>Not brain pathmap obstacle</u></a>: This NPC is not perceived as an obstacle to brain pathmaps (default), and brained pathmaps will not calculate paths around the NPC.</li>
    <li><a name="imp-npc-pathmap-obstacle"><u>NPC pathmap obstacle</u></a>: This NPC is perceived as an obstacle to other NPCs using the Pathfinding imperative. Other NPC pathmaps will be calculated around this NPC.</li>
    <li><a name="imp-not-npc-pathmap-obstacle"><u>Not NPC pathmap obstacle</u></a>: This NPC is not perceived as an obstacle to other NPCs using the Pathfinding imperative. Other NPC pathmaps will not be calculated around this NPC.</li>
	<li><a name="imp-ghost-display"><u>Ghost display</u></a>: When invisible this character will still be drawn to the screen. It will be drawn before (underneath) visible entities.</li>
	<li><a name="imp-ghost-display-overhead"><u>Ghost display overhead</u></a>: Just like <i>Ghost display</i> above, except the NPC will be drawn over other characters and monsters.</li>
	<li><a name="imp-no-ghost-display"><u>No ghost display</u></a>: Disables any previously activated <i>Ghost display</i> on this NPC.</li>
	<li><a name="imp-not-pushable"><u>Not pushable</u></a>: Makes this NPC resistant to any kind of pushing, even with weapons which naturally allow pushing (eg. staff).</li>
	<li><a name="imp-default-pushable-behavior"><u>Default pushable behavior</u></a>: Resets the pushability of the NPC to the default behavior.</li>
	<li><a name="imp-pushable-by-body"><u>Pushable by body</u></a>: Makes the NPC pushable by the body of the player, mimics, constructs and human-role characters (if a given entity is able to push mirrors it will also be able to push an NPC with this imperative). Regular, non-NPC guards, stalwarts, slayers and soldiers can't push mirrors and thus won't be able to push an NPC with this imperative. The same goes for all monsters except constructs which can push mirrors.</li>
	<li><a name="imp-pushable-by-weapon"><u>Pushable by weapon</u></a>: Makes the NPC pushable by any weapon effectively making it invulnerable to weapon attacks. It won't be able to push the NPC wielding dagger because dagger doesn't occupy a physical space. All other forms of attack still kill the NPC, including adders eating them, explosions, spike and fire traps.</li>
    <li><a name="imp-stunnable"><u>Stunnable</u></a>: Weapon pushes will stun this NPC.</li>
	<li><a name="imp-not-stunnable"><u>Not stunnable</u></a>: Weapon pushes will not stun this NPC, but it will not move on the turn it was pushed (unless it was pushed after it already moved).</li>
  </ol>

<p><a name="branchingexamples"><b>Examples of branching code structures:</b></a></p>
<ol>
  <li><a name="singlecodebranch">A single code branch:</a><br />
      <b>If ...</b><br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;condition&gt;<br />
      &nbsp;&nbsp;&nbsp;some optional commands here<br />
      <b>If End</b>
  </li>
  <br />
  <li><a name="twocodebranch">Two code branches:</a><br />
      <b>If ...</b><br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;condition&gt;<br />
      &nbsp;&nbsp;&nbsp;some commands here<br />
      <b>Else</b><br />
      &nbsp;&nbsp;&nbsp;some other commands here<br />
      <b>If End</b>
  </li>
  <br />
  <li><a name="nestedbranches">Nested branches:</a><br />
      <b>If ...</b><br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;condition&gt;<br />
      &nbsp;&nbsp;&nbsp;some commands here<br />
      &nbsp;&nbsp;&nbsp;<b>If ...</b><br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;condition&gt;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;some more commands here<br />
      &nbsp;&nbsp;&nbsp;<b>If End</b><br />
      &nbsp;&nbsp;&nbsp;some different commands here<br />
      <b>If End</b>
  </li>
</ol>

<p><a name="commandkeyexample"><b>Example of using the Special Command key</b></a></p>
  Speech Halph "Press Special Command to make me say something."<br />
Label "Loop"<br />
  Wait for event Player uses special command<br />
  Speech Happy Halph "You did it!"<br />
  Wait 0 turn(s)<br />
  Go to "Loop"<br />

<p><a name="world-map-command-ex"><b>Example of using World Map commands</b></a></p>
<p>When a player moves close to a level exit that transitions to an overworld map, use a script that defines a couple of locations on the map (level entrances) that the player can travel to in this manner:</p>
  Wait for entity Player 22,24,22,24<br />
  World Map Select 1<br />
  World Map Music 0,0<br />
  World Map Tile Icon Halph,Level state,100,100,1<br />
  World Map Tile Icon Beethro,Level state,200,200,2<br />
  End<br />
<p>This script should typically only be executed once, hence the "End" command that runs last.</p>

<p><a name="predefined-script-vars"><b>Predefined script vars</b></a></p>
<p>There are a number of predefined script vars that begin with an underscore.
You may select these in variable commands to examine or set certain game states.
For instance, you might query "<b>_LevelName</b>" in a global script to have it operate only in rooms on a certain level.<br />
"<b>_PlayerLightType</b>" affects the player's light in dark rooms.
Set it to a value &lt;0 to turn off, 0 to turn on, and from 1-100 to use a flashlight beam.  A higher value creates a more focused beam.<br />
Set "<b>_PlayerLight</b>" to a value between 0 (default) through 128 to alter the player's light intensity and color, as follows:<br />
16*(INTENSITY-1) + LIGHT_COLOR<br />
where INTENSITY is from 1-8 and LIGHT_COLOR is from 1-16.<br />
Variables prefixed with "_My" are connected to the state of the NPC, the "_*ImageX/Y" vars are tied to the defined origin for your room's custom images, and so forth.</p>

<p><a name="threatclockdisplay"><b>Threat clock display modes</b></a></p>
  You may set the predefined "_ThreatClock" script variable to modify dynamically how the threat clock is displayed during play. The supported values are:<br />
0: default<br />
1: hide<br />
2: always show<br />
3: backwards time<br />
100-129: display specific time (0-29)<br />
200-229: display specific half-tick (0-29)<br />

<p><a name="playerinputvars"><b>List of player command input variables</b></a></p>
  Predefined variable names may be provided in texts to output the player's current key binding for the respective command as text. To do this, provide a variable name of the form "$_CMD_&lt;key&gt;$", where &lt;key&gt; is one of the following:
<ol>
<li>MoveNorthwest</li>
<li>MoveNorth</li>
<li>MoveNortheast</li>
<li>MoveWest</li>
<li>Wait</li>
<li>MoveEast</li>
<li>MoveSouthwest</li>
<li>MoveSouth</li>
<li>MoveSoutheast</li>
<li>SwingClockwise</li>
<li>SwingCounterclockwise</li>
<li>Restart</li>
<li>Undo</li>
<li>Battle</li>
<li>UseCommand</li>
<li>CloneSwitch</li>
</ol>

<p><a name="image-overlay-commands"><b>Image overlay commands</b></a></p>
  In addition to selecting an image for display with the "Image overlay" command, you must provide a simple set of commands to define how the image will be displayed in-game.  The list of supported (case-insensitive) commands for use in an Image Overlay script is as follows:<br />
<br />
<b>CancelAll</b> -- remove all currently displaying image overlay effects. This command is typically run singly.<br />
<b>CancelLayer (layer #)</b> -- remove image overlay effects on the specified display layer (0 through 3)<br />
<b>Center</b> -- center the image within the room area<br />
<b>Display (ms)</b> -- display the image in its current form for the specified duration<br />
<b>DisplayRect (x) (y) (w) (h)</b> -- show this region of the source image<br />
<b>DisplaySize (w) (h)</b> -- show this amount of the source image, in pixels<br />
<b>DisplayTurns (# turns)</b> -- display the image in its current form for the indicated number of game turns<br />
<b>(p)FadeToAlpha (alpha) (ms)</b> -- transition the image from its current alpha value to the indicated value over the specified time interval<br />
<b>(p)Grow (percent of original) (ms)</b> -- scale the image by the indicated amount over the specified time interval<br />
<b>(p)Jitter (pixels) (ms)</b> -- randomly shake the image off-center up to the indicated range for the specified time interval<br />
<b>Layer (layer)</b> -- place the effect on the indicated display layer (0 through 3, generally corresponding to the menu tabs used for placing game elements in the room editor). Only the first instance of this command in a script is executed.<br />
<b>Loop (times)</b> -- loop through the image command list this many times (-1 = infinite)<br />
<b>(p)Move (x pixels) (y pixels) (ms)</b> -- translate the image's position by the indicated number of pixels over the indicated time interval<br />
<b>(p)MoveTo (x pixel) (y pixel) (ms)</b> -- move the image from its current position to the indicated screen location over the course of the indicated time interval<br />
<b>(p)Rotate (degrees) (ms)</b> -- rotate the image the indicated amount over the specified time interval<br />
<b>Scale (percent of original)</b> -- scale the image to the indicated amount<br />
<b>SetAlpha (0-255)</b> -- set the image's alpha transparency to the indicated value<br />
<b>SetAngle (degrees)</b> -- set the image's angle of rotation<br />
<b>SetX (pixel)</b> -- set the image's X coordinate<br />
<b>SetY (pixel)</b> -- set the image's Y coordinate<br />
<b>SrcXY (x) (y)</b> - show the source image starting from the indicated pixel position<br />
<br />
As an example, you can make an image start invisible, fade in, display for a couple seconds, then fade out by providing the following command sequence:<br />
<br />
setalpha 0 fadetoalpha 255 1000 display 2000 fadetoalpha 0 800<br />
<br />
The text supports variable interpolation, so you can have parameters like "$.ImageX$" in the text. Any part of the command text may be inserted in this fashion.<br />
Certain commands with time duration, marked above, may be optionally prefixed with the letter "p".  This indicates that the command will not run to completion before any subsequent commands are executed, but rather will run in parallel with the next command. Multiple parallel commands may be executed concurrently.<br />

<hr />
<a href="character.html">Character Scripting</a><br />
<a href="editroom.html">Room Editor</a><br />
<a href="editselect.html">Level Editor</a><br />
<a href="contents.html">Contents</a><br />
</body>
</html>
